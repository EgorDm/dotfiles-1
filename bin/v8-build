#! /bin/bash
#
# v8-build
# Copyright (C) 2013 Adrian Perez <aperez@igalia.com>
#
# Distributed under terms of the MIT license.
#

: ${CLANG:=1}
: ${ICECC:=0}
: ${ASAN:=0}

if [[ $# -eq 0 ]] ; then
    args=( x64.debug )
else
    args=( "$@" )
fi

if [[ -n ${ICECC} && ${ICECC} -ne 0 ]] ; then
	export CCACHE_PREFIX=/usr/lib/icecream/bin/icecc
	makej="-j15"
else
	makej="-j4"
fi

if [[ -n ${ASAN} && ${ASAN} -ne 0 ]] ; then
	CLANG=/usr/bin
	export ASAN_SYMBOLIZER_PATH="$CLANG/llvm-symbolizer"
	export CXX="$CLANG/clang++ -fsanitize=address -ferror-limit=1 -Qunused-arguments -stdlib=libc++"
	export CXX_host=${CXX}
	export LINK="$CLANG/clang++ -fsanitize=address -stdlib=libc++ -lc++abi"
	export CXXFLAGS="-O1 -fno-omit-frame-pointer -g"
	export CXXFLAGS_host=${CXXFLAGS}
	asan="asan=${CLANG}/clang++"
elif [[ -n ${CLANG} && ${CLANG} -ne 0 ]] ; then
	export CC='clang -ferror-limit=1 -Qunused-arguments -stdlib=libc++'
	export CXX='clang++ -ferror-limit=1 -Qunused-arguments -stdlib=libc++'
	export LINK='clang++ -stdlib=libc++ -lc++abi'
	export GYP_DEFINES="${GYP_DEFINES} clang=1"
	werror='werror=no'
fi

cat <<EOF

CLANG ..... : ${CLANG}
ICECC ..... : ${ICECC}
ASAN ...... : ${ASAN}
CC ........ : ${CC}
CXX ....... : ${CXX}
CXXFLAGS .. : ${CXXFLAGS}
LINK ...... : ${LINK}
GYP_DEFINES : ${GYP_DEFINES}

EOF

set -x
exec make \
	console=readline \
	disassembler=on \
	objectprint=on \
	verifyheap=on \
	extrachecks=on \
	gdbjit=on \
	deprecationwarnings=on \
	${asan} \
	${werror} \
	${makej} "${args[@]}"
