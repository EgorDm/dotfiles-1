#! /bin/bash
#
# v8-build
# Copyright (C) 2013 Adrian Perez <aperez@igalia.com>
#
# Distributed under terms of the MIT license.
#

: ${CLANG:=1}
: ${ICECC:=0}
: ${ASAN:=0}

makej="-j4"

if [[ -n ${ASAN} && ${ASAN} -ne 0 ]] ; then
	CLANG=/usr/bin
	export ASAN_SYMBOLIZER_PATH="$CLANG/llvm-symbolizer"
	export CXX="$CLANG/clang++ -fsanitize=address -ferror-limit=1 -Qunused-arguments -stdlib=libc++"
	export CXX_host=${CXX}
	export LINK="$CLANG/clang++ -fsanitize=address -stdlib=libc++ -lc++abi"
	export CXXFLAGS="-O1 -fno-omit-frame-pointer -g"
	export CXXFLAGS_host=${CXXFLAGS}
	asan="asan=${CLANG}/clang++"
elif [[ -n ${ICECC} && ${ICECC} -ne 0 ]] ; then
  # IceCC does not play well with clang
  export CC=gcc
  export CXX=g++
  export LINK=g++
	export CCACHE_PREFIX=/usr/lib/icecream/bin/icecc
  if [[ -z ${ICECC_VERSION} ]] ; then
    export ICECC_VERSION="$(pwd)/$(/usr/lib/icecream/bin/icecc --build-native 2>&1 |tee /dev/stderr|grep creating|awk '{print $2}')"
  fi
	makej="-j24"
elif [[ -n ${CLANG} && ${CLANG} -ne 0 ]] ; then
	export CC='clang -ferror-limit=1 -Qunused-arguments -stdlib=libc++'
	export CXX='clang++ -ferror-limit=1 -Qunused-arguments -stdlib=libc++'
	export LINK='clang++ -stdlib=libc++ -lc++abi'
	export GYP_DEFINES="${GYP_DEFINES} clang=1"
	werror='werror=no'
fi
export GYP_GENERATORS=ninja

cat <<EOF

CLANG ..... : ${CLANG}
ICECC ..... : ${ICECC}
ASAN ...... : ${ASAN}
CC ........ : ${CC}
CXX ....... : ${CXX}
CXXFLAGS .. : ${CXXFLAGS}
LINK ...... : ${LINK}
GYP_DEFINES : ${GYP_DEFINES}

EOF

builddir=out/Debug
if [[ -n $1 ]] ; then
	case $1 in
		rel | release | Release)
			builddir=out/Release
			;;
		dbg | debug | Debug)
			;;
		*)
			echo 'Usage: $0 [release | debug]' 1>&2
			exit 1
			;;
	esac
fi

set -x
./build/gyp_v8                     \
  -Dconsole=readline               \
  -Dwerror=''                      \
  -Dv8_enable_disassembler=1       \
  -Dv8_object_print=1              \
  -Dv8_enable_verify_heap=1        \
  -Dv8_enable_backtrace=1          \
  -Dv8_enable_verify_predictable=1 \
  -Ddcheck_always_on=1             \
  -Dv8_enable_handle_zapping=1     \
  -Dv8_enable_slow_dchecks=1       \
  -Dv8_enable_gdbjit=1             \
  -Dv8_deprecation_warnings=1      \
  -Dlinux_use_bundled_binutils=0   \
  -Dlinux_use_bundled_gold=0       \
  -Dlinux_use_gold_flags=1         \
  -Dlinux_use_debug_fission=0

exec ninja -C ${builddir} ${makej}
